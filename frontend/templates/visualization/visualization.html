{% extends "dashboard/layout.html" %}
{% block title %}FAIRMicrobiome | Visualization Tool{% endblock %}

{% block content %}
<div class="row justify-content-center">
   {% with messages = get_flashed_messages(with_categories=true) %}
   {% if messages %}
      <div class="container mt-3">
         {% for category, message in messages %}
         <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
         </div>
         {% endfor %}
      </div>
   {% endif %}
   {% endwith %}

   <h1>Visualization Tool for Beta Diversity
      <small class="text-muted">Exploratory Data Analysis</small>
   </h1>
   <div style="height:3vh;"></div>

   {% if stats_data %}
   <!-- Summary stats -->
   <div class="row mb-4">
      <div class="col-md-3">
         <div class="card text-center">
            <div class="card-body">
               <h5 class="card-title text-muted">Total Datasets</h5>
               <h2 class="text-primary">{{ stats_data.summary.total_datasets }}</h2>
            </div>
         </div>
      </div>
      <div class="col-md-3">
         <div class="card text-center">
            <div class="card-body">
               <h5 class="card-title text-muted">Total OTUs</h5>
               <h2 class="text-success">{{ "{:,}".format(stats_data.summary.total_rows) }}</h2>
            </div>
         </div>
      </div>
      <div class="col-md-3">
         <div class="card text-center">
            <div class="card-body">
               <h5 class="card-title text-muted">Total Samples</h5>
               <h2 class="text-info">{{ stats_data.summary.total_columns }}</h2>
            </div>
         </div>
      </div>
      <div class="col-md-3">
         <div class="card text-center">
            <div class="card-body">
               <h5 class="card-title text-muted">Avg OTUs/Dataset</h5>
               <h2 class="text-warning">{{ "{:,}".format(stats_data.summary.avg_rows) }}</h2>
            </div>
         </div>
      </div>
   </div>

   <!-- Charts -->
   <div class="row mb-4">
      <div class="col-md-6">
         <div class="card">
            <div class="card-header">
               <h5>OTUs per Dataset</h5>
            </div>
            <div class="card-body">
               <canvas id="rowsChart"></canvas>
            </div>
         </div>
      </div>
      <div class="col-md-6">
         <div class="card">
            <div class="card-header">
               <h5>Samples per Dataset</h5>
            </div>
            <div class="card-body">
               <canvas id="columnsChart"></canvas>
            </div>
         </div>
      </div>
   </div>

   <!-- Dataset  -->
   <div class="row">
      <div class="col-md-12">
         <div class="card">
            <div class="card-header">
               <h5>Dataset Details</h5>
            </div>
            <div class="card-body">
               <div class="table-responsive">
                  <table class="table table-striped table-hover">
                     <thead>
                        <tr>
                           <th>Table Name</th>
                           <th>OTUs</th>
                           <th>Samples</th>
                        </tr>
                     </thead>
                     <tbody>
                        {% for table in stats_data.tables %}
                        <tr>
                           <td><code>{{ table.name }}</code></td>
                           <td>{{ "{:,}".format(table.rows) }}</td>
                           <td>{{ table.columns }}</td>
                        </tr>
                        {% endfor %}
                     </tbody>
                  </table>
               </div>
            </div>
         </div>
      </div>
   </div>
   {% else %}
   <div class="alert alert-info">
      <i class="fas fa-info-circle"></i> No dataset statistics available. Please upload some data first.
   </div>
   {% endif %}

   <!-- Dataset-Specific Visualization -->
   <div style="height:5vh;"></div>
   <hr>
   <h2 class="mt-5">Dataset-Specific Visualization
      <small class="text-muted">Beta Diversity Heatmap & PCoA</small>
   </h2>
   <div style="height:2vh;"></div>

   {% if stats_data and stats_data.tables %}
   <!-- Controls  -->
   <div class="row">
      <div class="col-12">
         <div class="card">
            <div class="card-header">
               <h5><i class="fas fa-sliders-h"></i> Visualization Controls</h5>
            </div>
            <div class="card-body">
               <form id="viz-form" method="GET" action="">
                  <div class="row">
                     <div class="col-md-6 mb-3">
                        <label for="dataset-select" class="form-label">Select Dataset</label>
                        <select id="dataset-select" name="dataset" class="form-select" required>
                           <option value="">-- Choose a dataset --</option>
                           {% for table in stats_data.tables %}
                           <option value="{{ table.name }}" {% if table_name == table.name %}selected{% endif %}>
                              {{ table.name }} ({{ "{:,}".format(table.rows) }} OTUs, {{ table.columns }} samples)
                           </option>
                           {% endfor %}
                        </select>

                        <!-- Metadata Status  -->
                        {% if table_name %}
                           {% if has_metadata %}
                           <div class="alert alert-success mt-2 mb-0" role="alert">
                              <i class="fas fa-check-circle"></i> <strong>Metadata Linked to Dataset</strong>
                              <br>
                              <small>Fields: {{ metadata_fields|join(', ') }}</small>
                           </div>
                           {% else %}
                           <div class="alert alert-warning mt-2 mb-0" role="alert">
                              <i class="fas fa-exclamation-triangle"></i> <strong>No Metadata Linked</strong>
                           </div>
                           {% endif %}
                        {% endif %}
                     </div>
                     <div class="col-md-3 mb-3">
                        <label for="row-limit" class="form-label">OTUs (max 10000)</label>
                        <input type="number" id="row-limit" name="row_limit" class="form-control"
                               min="1" max="10000" value="{{ row_limit or 50 }}" required>
                        <small class="form-text text-muted">Number of OTU's to analyze</small>
                     </div>
                     <div class="col-md-3 mb-3">
                        <label for="column-limit" class="form-label">Samples (max 200)</label>
                        <input type="number" id="column-limit" name="column_limit" class="form-control"
                               min="2" max="200" value="{{ column_limit or 10 }}" required>
                        <small class="form-text text-muted">Number of samples to compare</small>
                     </div>
                  </div>
                  <div class="row">
                     <div class="col-md-4 mb-3">
                        <label for="metric-select" class="form-label">Distance Metric</label>
                        <select id="metric-select" name="metric" class="form-select" required>
                           <option value="bray_curtis" {% if metric == 'bray_curtis' or not metric %}selected{% endif %}>
                              Bray-Curtis Dissimilarity (does not take compositionality into account)
                           </option>
                           <option value="aitchison" {% if metric == 'aitchison' %}selected{% endif %}>
                              Aitchison Distance (CLR-transformed, compositional aware)
                           </option>
                        </select>
                        <small class="form-text text-muted">
                           Bray-Curtis: Standard distance | Aitchison: Compositional data analysis
                        </small>
                     </div>
                     <div class="col-md-4 mb-3" id="pseudocount-container" style="display: none;">
                        <label for="pseudocount-select" class="form-label">Pseudocount (for CLR)</label>
                        <select id="pseudocount-select" name="pseudocount" class="form-select">
                           <option value="1" {% if pseudocount == 1.0 or not pseudocount %}selected{% endif %}>
                              1.0
                           </option>
                           <option value="0.5" {% if pseudocount == 0.5 %}selected{% endif %}>
                              0.5
                           </option>
                           <option value="0.1" {% if pseudocount == 0.1 %}selected{% endif %}>
                              0.1
                           </option>
                           <option value="0.01" {% if pseudocount == 0.01 %}selected{% endif %}>
                              0.01
                           </option>
                           <option value="0.001" {% if pseudocount == 0.001 %}selected{% endif %}>
                              0.001
                           </option>
                        </select>
                        <small class="form-text text-muted">
                           Value added to each cell before CLR transformation to avoid log(0)
                        </small>
                     </div>
                     <div class="col-md-4 mb-3">
                        <label for="colorscale-select" class="form-label">Color Palette</label>
                        <select id="colorscale-select" name="colorscale" class="form-select" required>
                           <option value="Viridis" {% if colorscale == 'Viridis' or not colorscale %}selected{% endif %}>
                              Viridis (Colorblind Friendly - All Types)
                           </option>
                           <option value="Cividis" {% if colorscale == 'Cividis' %}selected{% endif %}>
                              Cividis (Colorblind Friendly - All Types)
                           </option>
                           <option value="Magma" {% if colorscale == 'Magma' %}selected{% endif %}>
                              Magma (Colorblind Friendly - All Types)
                           </option>
                        </select>
                        <small class="form-text text-muted">
                           All palettes are colorblind-friendly
                        </small>
                     </div>
                  </div>
                  <div class="row">
                     <div class="col-12">
                        <button type="submit" class="btn btn-primary-custom btn-lg">
                           <i class="fas fa-chart-area"></i> Generate Beta Diversity Visualizations
                        </button>
                        {% if table_name %}
                        <a href="/data/upload_metadata/{{ table_name }}" class="btn btn-info ms-2">
                           <i class="fas fa-tags"></i> Upload Metadata if not linked
                        </a>
                        {% endif %}
                     </div>
                  </div>
               </form>
            </div>
         </div>
      </div>
   </div>

   <!-- Visualization -->
   {% if viz_data and viz_data.success %}
   <div class="row mt-4">
      <div class="col-12">
         <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
               <div>
                  <h5><i class="fas fa-chart-area"></i> Beta Diversity Heatmap - {{ table_name }}</h5>
                  <small class="text-muted">
                     {% if viz_data.data.metric == 'aitchison' %}
                        Aitchison Distance (CLR-transformed)
                     {% else %}
                        Bray-Curtis Dissimilarity
                     {% endif %} |
                     {{ viz_data.data.row_count }} OTUs Ã— {{ viz_data.data.column_count }} Samples |
                     Processing time: {{ viz_data.metadata.processing_time_ms }}ms
                  </small>
               </div>
               <button type="button" class="btn btn-secondary btn-sm" onclick="exportHeatmap()">
                  <i class="fas fa-download"></i> Export as SVG
               </button>
            </div>
            <div class="card-body">
               <div id="heatmap-container" style="width: 100%; height: 700px;"></div>
               {% if viz_data.data.total_columns_available > viz_data.data.column_count %}
               <div class="alert alert-info mt-3">
                  <i class="fas fa-info-circle"></i>
                  Showing {{ viz_data.data.column_count }} of {{ viz_data.data.total_columns_available }} available samples.
                  Increase the "Samples" limit to include more. Maximum allowed is 2000 samples.
               </div>
               {% endif %}
            </div>
         </div>
      </div>
   </div>

   <!-- PCoA Plot -->
   {% if viz_data.data.pcoa_coordinates %}
   <div class="row mt-4">
      <div class="col-12">
         <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
               <div>
                  <h5><i class="fas fa-project-diagram"></i> PCoA Ordination Plot - {{ table_name }}</h5>
                  <small class="text-muted">
                     {% if viz_data.data.metric == 'aitchison' %}
                        Aitchison Distance (CLR-transformed)
                     {% else %}
                        Bray-Curtis Dissimilarity
                     {% endif %} |
                     PC1: {{ "%.1f" | format(viz_data.data.explained_variance[0]) }}% |
                     PC2: {{ "%.1f" | format(viz_data.data.explained_variance[1]) }}% |
                     Total variance explained: {{ "%.1f" | format(viz_data.data.explained_variance[0] + viz_data.data.explained_variance[1]) }}%
                  </small>
               </div>
               <button type="button" class="btn btn-secondary btn-sm" onclick="exportPCoA()">
                  <i class="fas fa-download"></i> Export as SVG
               </button>
            </div>
            <div class="card-body">
               {% if has_metadata and metadata_fields %}
               <div class="row mb-3">
                  <div class="col-md-6">
                     <label for="metadata-selector" class="form-label">
                        <i class="fas fa-palette"></i> Color & Shape by Metadata Field
                     </label>
                     <select id="metadata-selector" class="form-select">
                        <option value="">None (color by PC1)</option>
                        {% for field in metadata_fields %}
                        <option value="{{ field }}" {% if loop.first %}selected{% endif %}>{{ field }}</option>
                        {% endfor %}
                     </select>
                     <small class="form-text text-muted">Select a metadata field to color and shape the points</small>
                  </div>
               </div>
               {% endif %}
               <div id="pcoa-container" style="width: 100%; height: 600px;"></div>
               <div class="mt-3">
                  <p class="text-muted mb-1"><strong>How to interpret:</strong></p>
                  <ul class="text-muted small">
                     <li>Each point represents a sample</li>
                     <li>Closer points = more similar microbial communities</li>
                     <li>Axes show principal coordinates explaining most variance</li>
                     <li>Percentage values show how much variation each axis captures</li>
                  </ul>
               </div>
            </div>
         </div>
      </div>
   </div>
   {% endif %}

   {% elif table_name %}
   <div class="row mt-4">
      <div class="col-12">
         <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle"></i>
            Unable to generate visualization. Please check the error messages above.
         </div>
      </div>
   </div>
   {% else %}
   <div class="row mt-4">
      <div class="col-12">
         <div class="alert alert-info">
            <i class="fas fa-info-circle"></i>
            Select a dataset and click "Generate Beta Diversity Visualizations" to visualize the data.
         </div>
      </div>
   </div>
   {% endif %}
   {% endif %}
</div>

<!-- Chart.js Script -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<!-- Plotly.js for Heatmap -->
<script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>

<script>
   // Get stats data from the edge functions
   const statsData = {{ stats_json | safe }};

   if (statsData && statsData.tables) {
      // make data in right format
      const tableNames = statsData.tables.map(t => t.name.replace(/_/g, ' ').substring(0, 20) + '...');
      const rowCounts = statsData.tables.map(t => t.rows);
      const columnCounts = statsData.tables.map(t => t.columns);

      // Rows Chart
      const rowsCtx = document.getElementById('rowsChart').getContext('2d');
      new Chart(rowsCtx, {
         type: 'bar',
         data: {
            labels: tableNames,
            datasets: [{
               label: 'Number of OTUs',
               data: rowCounts,
               backgroundColor: 'rgba(40, 167, 69, 0.6)',
               borderColor: 'rgba(40, 167, 69, 1)',
               borderWidth: 1
            }]
         },
         options: {
            responsive: true,
            maintainAspectRatio: true,
            scales: {
               y: {
                  beginAtZero: true
               }
            }
         }
      });

      // Columns Chart
      const columnsCtx = document.getElementById('columnsChart').getContext('2d');
      new Chart(columnsCtx, {
         type: 'bar',
         data: {
            labels: tableNames,
            datasets: [{
               label: 'Number of Samples',
               data: columnCounts,
               backgroundColor: 'rgba(23, 162, 184, 0.6)',
               borderColor: 'rgba(23, 162, 184, 1)',
               borderWidth: 1
            }]
         },
         options: {
            responsive: true,
            maintainAspectRatio: true,
            scales: {
               y: {
                  beginAtZero: true
               }
            }
         }
      });
   }

   //  pseudocount visibility based on metric selection
   const metricSelect = document.getElementById('metric-select');
   const pseudocountContainer = document.getElementById('pseudocount-container');

   function togglePseudocount() {
      if (metricSelect && pseudocountContainer) {
         if (metricSelect.value === 'aitchison') {
            pseudocountContainer.style.display = 'block';
         } else {
            pseudocountContainer.style.display = 'none';
         }
      }
   }

   if (metricSelect) {
      metricSelect.addEventListener('change', togglePseudocount);
      togglePseudocount();
   }

   // Handle form submission for visualization
   const vizForm = document.getElementById('viz-form');
   if (vizForm) {
      vizForm.addEventListener('submit', function(e) {
         e.preventDefault();

         const datasetSelect = document.getElementById('dataset-select');
         const rowLimitInput = document.getElementById('row-limit');
         const colLimitInput = document.getElementById('column-limit');
         const pseudocountSelect = document.getElementById('pseudocount-select');
         const colorscaleSelect = document.getElementById('colorscale-select');

         if (!datasetSelect || !rowLimitInput || !colLimitInput || !metricSelect || !colorscaleSelect) {
            console.error('Form elements not found');
            return;
         }

         const dataset = datasetSelect.value;
         const rowLimit = rowLimitInput.value;
         const colLimit = colLimitInput.value;
         const metric = metricSelect.value;
         const colorscale = colorscaleSelect.value;
         const pseudocount = pseudocountSelect ? pseudocountSelect.value : '1';

         if (!dataset) {
            alert('Please select a dataset');
            return;
         }

         // Redirect to visualization route with parameters
         window.location.href = `/visualization/dataset/${dataset}?row_limit=${rowLimit}&column_limit=${colLimit}&metric=${metric}&colorscale=${colorscale}&pseudocount=${pseudocount}`;
      });
   }

   // Render Beta Diversity Heatmap if data is available
   {% if viz_data and viz_data.success %}
   try {
      const vizData = {{ viz_json | safe }};
      console.log('Viz data loaded:', vizData);

      if (vizData && vizData.success && vizData.data) {
         const heatmapContainer = document.getElementById('heatmap-container');

         if (!heatmapContainer) {
            console.error('Heatmap container not found!');
         } else if (typeof Plotly === 'undefined') {
            console.error('Plotly.js not loaded!');
         } else {
            console.log('Rendering heatmap...');

            // scale
            const isAitchison = vizData.data.metric === 'aitchison';
            const colorbarTitle = isAitchison
               ? 'Aitchison<br>Distance'
               : 'Bray-Curtis<br>Dissimilarity';

            // Bray-Curtis:  0-1, Aitchison:  (auto scale)
            const scaleConfig = isAitchison
               ? { zmin: 0 }  // Let Plotly decide the max for Aitchison
               : { zmin: 0, zmax: 1 };  // Fixed scale for Bray-Curtis

            // get the right color pallette
            const selectedColorscale = '{{ colorscale }}' || 'Viridis';

            const needsReverse = false;

            const data = [{
               z: vizData.data.distance_matrix,
               x: vizData.data.sample_names,
               y: vizData.data.sample_names,
               type: 'heatmap',
               colorscale: selectedColorscale,
               reversescale: needsReverse,
               showscale: true,
               colorbar: {
                  title: {
                     text: colorbarTitle,
                     side: 'right'
                  },
                  tickformat: '.2f',
                  len: 0.7
               },
               hovertemplate: '<b>%{x}</b><br><b>%{y}</b><br>Distance: %{z:.3f}<extra></extra>',
               ...scaleConfig
            }];

            const metricTitle = vizData.data.metric === 'aitchison'
               ? 'Beta Diversity Heatmap (Aitchison Distance Metric)<br><sub>Higher values indicate greater differences in relative composition between samples </sub>'
               : 'Beta Diversity Heatmap (Bray-Curtis Dissimilarity Matrix)<br><sub>Lower values indicate greater similarity; higher values indicate greater dissimilarity between samples.</sub>';

            const layout = {
               title: {
                  text: metricTitle,
                  font: { size: 20 }
               },
               xaxis: {
                  title: 'Samples',
                  tickangle: -45,
                  side: 'bottom',
                  tickfont: { size: 10 }
               },
               yaxis: {
                  title: 'Samples',
                  tickfont: { size: 10 },
                  autorange: 'reversed'
               },
               height: 700,
               margin: { l: 100, r: 150, t: 100, b: 150 },
               paper_bgcolor: '#ffffff',
               plot_bgcolor: '#ffffff'
            };

            const config = {
               responsive: true,
               displayModeBar: true,
               displaylogo: false,
               modeBarButtonsToRemove: ['lasso2d', 'select2d'],
               toImageButtonOptions: {
                  format: 'svg',
                  filename: 'beta_diversity_' + vizData.metadata.table_name,
                  height: 1000,
                  width: 1000,
                  scale: 2
               }
            };

            Plotly.newPlot('heatmap-container', data, layout, config)
               .then(function() {
                  console.log('Heatmap rendered successfully!');
               })
               .catch(function(err) {
                  console.error('Plotly rendering error:', err);
               });
         }
      } else {
         console.error('Invalid viz data structure');
      }
   } catch (error) {
      console.error('Error rendering heatmap:', error);
   }
   {% endif %}

   // Render PCoA Plot if data is available
   {% if viz_data and viz_data.success and viz_data.data.pcoa_coordinates %}
   try {
      const vizData = {{ viz_json | safe }};
      console.log('PCoA data loaded:', vizData.data.pcoa_coordinates);

      if (vizData && vizData.success && vizData.data.pcoa_coordinates) {
         const pcoaContainer = document.getElementById('pcoa-container');

         if (!pcoaContainer) {
            console.error('PCoA container not found!');
         } else if (typeof Plotly === 'undefined') {
            console.error('Plotly.js not loaded!');
         } else {
            console.log('Rendering PCoA plot...');

            const coords = vizData.data.pcoa_coordinates;
            const sampleNames = vizData.data.sample_names;
            const explainedVar = vizData.data.explained_variance;

            // Get the metadata
            const metadata = {{ metadata | safe }};
            const metadataFields = {{ metadata_fields | tojson }};
            const hasMetadata = {{ has_metadata | tojson }};

            // color and shapes for plot
            const colorPalette = ['#e41a1c','#377eb8','#4daf4a','#984ea3','#ff7f00','#ffff33','#a65628','#f781bf'];
            const shapePalette = ['circle', 'square', 'diamond', 'triangle-up', 'star', 'pentagon', 'hexagon', 'cross'];

            // ellipses for grouping
            function createEllipse(xCoords, yCoords) {
               // center
               const cx = xCoords.reduce((a, b) => a + b, 0) / xCoords.length;
               const cy = yCoords.reduce((a, b) => a + b, 0) / yCoords.length;

               // standard deviations (use 2 std devs for ~95% coverage)
               const xStd = Math.sqrt(xCoords.reduce((sum, x) => sum + Math.pow(x - cx, 2), 0) / xCoords.length) * 2;
               const yStd = Math.sqrt(yCoords.reduce((sum, y) => sum + Math.pow(y - cy, 2), 0) / yCoords.length) * 2;

               // Return ellipse path
               return {
                  type: 'circle',
                  xref: 'x',
                  yref: 'y',
                  x0: cx - xStd,
                  y0: cy - yStd,
                  x1: cx + xStd,
                  y1: cy + yStd
               };
            }

            // Function to render PCoA plot with selected metadata field
            function renderPCoAPlot(selectedField) {
               console.log('Rendering PCoA with field:', selectedField);

               let pcoaData = [];
               let shapes = [];

               if (selectedField && hasMetadata) {
                  // Group samples by metadata value
                  const groups = {};
                  sampleNames.forEach((sampleName, idx) => {
                     const metaValue = metadata[sampleName] && metadata[sampleName][selectedField]
                        ? metadata[sampleName][selectedField]
                        : 'Unknown';

                     if (!groups[metaValue]) {
                        groups[metaValue] = {
                           x: [],
                           y: [],
                           text: [],
                           indices: []
                        };
                     }
                     groups[metaValue].x.push(coords[idx][0]);
                     groups[metaValue].y.push(coords[idx][1]);
                     groups[metaValue].text.push(sampleName);
                     groups[metaValue].indices.push(idx);
                  });

                  const groupNames = Object.keys(groups).sort();
                  groupNames.forEach((groupName, i) => {
                     const group = groups[groupName];
                     const groupColor = colorPalette[i % colorPalette.length];

                     pcoaData.push({
                        x: group.x,
                        y: group.y,
                        mode: 'markers+text',
                        type: 'scatter',
                        name: groupName,
                        text: group.text,
                        textposition: 'top center',
                        textfont: { size: 10 },
                        marker: {
                           size: 12,
                           color: groupColor,
                           symbol: shapePalette[i % shapePalette.length],
                           line: {
                              color: 'white',
                              width: 1
                           }
                        },
                        hovertemplate: '<b>%{text}</b><br>' + selectedField + ': ' + groupName + '<br>PC1: %{x:.3f}<br>PC2: %{y:.3f}<extra></extra>'
                     });

                     // Add ellipse outline for groups with more than 2 points
                     if (group.x.length >= 2) {
                        const ellipse = createEllipse(group.x, group.y);
                        shapes.push({
                           ...ellipse,
                           fillcolor: 'rgba(0, 0, 0, 0)',  // Fully transparent
                           line: {
                              color: groupColor,
                              width: 2
                           },
                           layer: 'below'
                        });
                     }
                  });
               } else {
                  // No metadata selected is single color, no legend
                  pcoaData = [{
                     x: coords.map(c => c[0]),
                     y: coords.map(c => c[1]),
                     mode: 'markers+text',
                     type: 'scatter',
                     name: 'Samples',
                     text: sampleNames,
                     textposition: 'top center',
                     textfont: { size: 10 },
                     marker: {
                        size: 12,
                        color: '#377eb8',  // Single blue color
                        line: {
                           color: 'white',
                           width: 1
                        }
                     },
                     hovertemplate: '<b>%{text}</b><br>PC1: %{x:.3f}<br>PC2: %{y:.3f}<extra></extra>',
                     showlegend: false
                  }];
               }

               const pcoaLayout = {
                  title: {
                     text: `PCoA Ordination<br><sub>${vizData.data.metric === 'aitchison' ? 'Aitchison Distance' : 'Bray-Curtis Dissimilarity'}</sub>`,
                     font: { size: 18 }
                  },
                  xaxis: {
                     title: `PC1 (${explainedVar[0].toFixed(1)}% variance)`,
                     zeroline: true,
                     zerolinewidth: 2,
                     zerolinecolor: 'gray',
                     gridcolor: '#e0e0e0'
                  },
                  yaxis: {
                     title: `PC2 (${explainedVar[1].toFixed(1)}% variance)`,
                     zeroline: true,
                     zerolinewidth: 2,
                     zerolinecolor: 'gray',
                     gridcolor: '#e0e0e0'
                  },
                  height: 600,
                  hovermode: 'closest',
                  showlegend: selectedField && hasMetadata,
                  legend: {
                     x: 1.02,
                     y: 1,
                     xanchor: 'left',
                     yanchor: 'top',
                     bgcolor: 'rgba(255, 255, 255, 0.8)',
                     bordercolor: '#ddd',
                     borderwidth: 1
                  },
                  shapes: shapes,
                  margin: { l: 80, r: 150, t: 100, b: 80 },
                  paper_bgcolor: '#ffffff',
                  plot_bgcolor: '#fafafa'
               };

               const pcoaConfig = {
                  responsive: true,
                  displayModeBar: true,
                  displaylogo: false,
                  modeBarButtonsToRemove: ['lasso2d', 'select2d'],
                  toImageButtonOptions: {
                     format: 'svg',
                     filename: 'pcoa_ordination_' + vizData.metadata.table_name,
                     height: 800,
                     width: 1000,
                     scale: 2
                  }
               };

               // Use Plotly.react for updates
               Plotly.react('pcoa-container', pcoaData, pcoaLayout, pcoaConfig)
                  .then(function() {
                     console.log('PCoA plot rendered successfully!');
                  })
                  .catch(function(err) {
                     console.error('Plotly PCoA rendering error:', err);
                  });
            }

            // Initial render with first metadata field (if available)
            const initialField = hasMetadata && metadataFields.length > 0 ? metadataFields[0] : null;
            renderPCoAPlot(initialField);

            // Add event listener to metadata selector
            const metadataSelector = document.getElementById('metadata-selector');
            if (metadataSelector) {
               metadataSelector.addEventListener('change', function(e) {
                  const selectedField = e.target.value;
                  renderPCoAPlot(selectedField || null);
               });
            }
         }
      }
   } catch (error) {
      console.error('Error rendering PCoA plot:', error);
   }
   {% endif %}

   // Export heatmap to svg
   function exportHeatmap() {
      Plotly.downloadImage(document.getElementById('heatmap-container'), {
         format: 'svg',
         width: 1200,
         height: 1200,
         filename: 'beta_diversity_heatmap'
      });
   }

   // Export PCoA to svg
   function exportPCoA() {
      Plotly.downloadImage(document.getElementById('pcoa-container'), {
         format: 'svg',
         width: 1000,
         height: 800,
         filename: 'pcoa_ordination'
      });
   }
</script>
{% endblock %}
